<!DOCTYPE html>
<html lang="en">
	<head>
		<title>swipe controller</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="manifest" href="./manifest.json">
		<style type="text/css">
			
			html, body {
				width: 100%;
				height: 100%;
				margin: 0;
			} 			
			.touch-space {
				background-color: #cccccc;
				width: 100%;
				height: 120%;
			}

			.pad-background {
				border: solid 1px #949494;
				position: absolute;
				width: 200px;
				height: 200px;
				border-radius: 100px;
			}

			#left-pad-background {
				left: 80px;
			    top: 80px;
			}

			#right-pad-background {
				left: 380px;
    			top: 80px;
			}


			.swipe-pad {
				position: absolute;
			    background-color: red;
			    width: 160px;
			    height: 160px;
			    border-radius: 80px;
			    box-shadow: 2px 2px 2px #676767;
			}

			#left-pad {
				left: 100px;
			    top: 100px;
			}

			#right-pad {
				left: 400px;
    			top: 100px;
			}

		</style>	
	</head>
	<body>

		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="https://rtc-world-s.herokuapp.com/socket.io/socket.io.js"></script> 
		<script type="text/javascript" src="./scripts/core/android-service.js"></script>


		<div class="touch-space">
			<div class="pad-background" id="left-pad-background"></div>
			<div class="pad-background" id="right-pad-background"></div>
			<div class="swipe-pad" id="left-pad"></div>
			<div class="swipe-pad" id="right-pad"></div>
		</div>
  
		<script>

		'use strict';
		$(function(){

			$(".swipe-pad").on("mousedown", onTouchStart);
	   		$(".swipe-pad").bind("touchstart", onTouchStart);

			var SWIPE_PAD_SYMBOL = {
				RIGHT: "right",
				LEFT: "left"
			};
		 	
		 	var swipeData = {};

		 	swipeData[SWIPE_PAD_SYMBOL.RIGHT] = {
				start: {x:400, y:100},
	 			dragOffset : {x: 0, y:0}
	 		};

	 		swipeData[SWIPE_PAD_SYMBOL.LEFT] = {
				start: {x:100, y:100},
	 			dragOffset : {x: 0, y:0}
	 		};

	 		var androidService;

		  	//スワイプ開始時の横方向の座標を格納
		  	function onTouchStart(e) {
		    	//クラス名に .drag を追加
			    $(this).addClass("drag");
			    //タッチデイベントとマウスのイベントの差異を吸収
			    //if(e.type === "mousedown") {
			    if(e.type === "mousedown") {
			        var event = e;
			    } else {
			    	var event = getTouchEvent(e);
			    }

			    var swipeSymbol = getSWipeSymbol(this);

			    console.log(swipeSymbol);

			    if(!swipeSymbol){
			    	return ;
			    }

			    //要素内の相対座標を取得
			    swipeData[swipeSymbol].dragOffset.x = event.pageX - this.offsetLeft;
			    swipeData[swipeSymbol].dragOffset.y = event.pageY - this.offsetTop;

			    //swipeData[swipeSymbol].start.x = event.pageX ;
			    //swipeData[swipeSymbol].start.y = event.pageY;

			    //ムーブイベントにコールバック
			    if('ontouchstart' in window){
			    	$(this).bind("touchmove", onTouchMove);
			    	$(this).bind("touchend", onTouchEnd);
			    	$(this).bind("touchleave", onTouchEnd);

			    }else{
			    	
			    	$(this).on("mousemove", onTouchMove);
			    	$(this).on("mouseup",  onTouchEnd);
			    	$(this).on("mouseleave", onTouchEnd);
			   	}


			    this.touched = true; // フラグを立てる
			}

		  	function onTouchMove(e) {
		    	// 開始していない場合は動かないようにする
				// 過剰動作の防止
				if (!this.touched) {
					return;
				}
			    //ドラッグしている要素を取得
			    //var drag = document.getElementsByClassName("drag")[0];
			    var drag = this;

				var swipeSymbol = getSWipeSymbol(this);

			    //同様にマウスとタッチの差異を吸収
			    if(e.type === "mousemove") {
			        var event = e;
			    } else {
			    	var event = getTouchEvent(e);
			    }
			    
			    //フリックしたときに画面を動かさないようにデフォルト動作を抑制
			    e.preventDefault();

			    var padPosX = event.pageX - swipeData[swipeSymbol].dragOffset.x;
			    var padPosY = event.pageY - swipeData[swipeSymbol].dragOffset.y;
			    //マウスが動いた場所に要素を動かす
			   	setPosition($(drag), padPosX, padPosY);

			   	var padOffsetX = padPosX - swipeData[swipeSymbol].start.x;
			   	var padOffsetY = padPosY - swipeData[swipeSymbol].start.y;
			   	sendPosition(swipeSymbol, padOffsetX, padOffsetY);

		  	}

		  	function onTouchEnd(e) {
		  		if (!this.touched) {
					return;
				}
				// タッチ処理は終了したため、フラグをたたむ
				this.touched = false;
			   
			    var drag = this;

			     //同様にマウスとタッチの差異を吸収
			    if(e.type === "mouseup" || e.type === "mouseleave") {
			        var event = e;
			    } else {
			    	var event = getTouchEvent(e);	
			    }

			    //ムーブベントハンドラの消去
			    $(this).unbind("mousemove", onTouchMove);
			    $(this).unbind("mouseup", onTouchEnd);
			    $(this).unbind("mouseleave", onTouchEnd);
			    $(this).unbind("touchmove", onTouchMove);
			    $(this).unbind("touchend", onTouchEnd);
			    $(this).unbind("touchleave", onTouchEnd);

				var swipeSymbol = getSWipeSymbol(this);

			   	setPosition($(this), swipeData[swipeSymbol].start.x, swipeData[swipeSymbol].start.y);
			   	sendPosition(swipeSymbol, 0, 0);

			    
			    //クラス名 .drag も消す
			    $(drag).removeClass("drag");
			    	
			}

			function getTouchEvent(e) {
				var originalEvent = e.originalEvent;
				var event = originalEvent.changedTouches[0];

				return event;
			}

			function getSWipeSymbol(dom){
				
				var symbol = null;
				
				if($(dom).attr("id") === 'left-pad'){
					symbol = SWIPE_PAD_SYMBOL.LEFT;
				} else if($(dom).attr("id") === 'right-pad'){
					symbol = SWIPE_PAD_SYMBOL.RIGHT;
				}

				return symbol;
			}

			function setPosition(jq_obj, x, y) {
				jq_obj.css("top",  y + "px");
				jq_obj.css("left", x + "px");
			}

			function sendPosition(swipeSymbol, x, y){
				
				if(!androidService || !androidService.WSisConnected()){
					return;
				}
			   	
			   	var motorSymbol = swipeSymbol === SWIPE_PAD_SYMBOL.LEFT
			   		? "motorLeft"
			   		: "motorRight";

			   	var control = {};
			   	control[motorSymbol] = y;

			   	androidService.WSpost({
			   		control : control
			   	});
			}

			var update = function(){

			}
			
			androidService = new AndroidService();

			var WSUrl = "https://rtc-world-s.herokuapp.com";
			var WSRoomName = "androino-socketroid";
			androidService.WSinit(WSUrl, WSRoomName, function(message){
				console.log(message);
			}, function(myId){
				console.log("WSconnected!! myId = " + myId);
			}, function(){
				console.log("WSdisconnected!!");
			});

		});
		
		</script>
	</body>
</html>
